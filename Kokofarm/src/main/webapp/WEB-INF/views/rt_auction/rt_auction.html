<meta charset="UTF-8">
<title>실시간 경매</title>
<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script>
$(document).ready(function(){
////////////////////////////////////////////////////////////////
/* 입찰 버튼 이벤트  */
	// cart open
	$('#auction_btn').click(function() {
		$("#rt_tender").focus();
		if (!$(this).data('ch')) {
			$(this).data('ch', 1).addClass('on');
			$('.auction_menu').animate({
				bottom : '0'
			}, 200);
		} else {
			$(this).data('ch', 0).removeClass('on');
			if ($(this).isCilck == true) {
				$('.auction_menu').delay(1500).animate({
					bottom : '-80px'
				}, 200);
			} else {
				$('.auction_menu').animate({
					bottom : '-80px'
				}, 200);
			}
			isCilck = false;
		}
	});
	
//////////////////////////////////////////////////////////////////
/* Node.Js 소켓 통신 할 구분 */

	var socket = io.connect(); //소켓 연결
	
	$("#chat_text").focus(); // 채팅 입력창으로 포커스 지정
	
	socket.on('info',function(data){ //get방식으로 정보를 받는다
		$("#rt_name").text(data.product_n);
		$("#tender_price").text(numberFormat(data.down));
		$("#rt_standard").text(data.unit);
		$("#rt_img").attr("src",data.img);
		$("#rt_img01").attr("src",data.img01);
		$("#rt_img02").attr("src",data.img02);
		$("#rt_content").empty();
		$("#rt_content").append(data.content);
		$("#rt_area").text(data.area);
		$("#rt_seller").text(data.seller_no);
		$("#rt_auction_no").text(data.rt_auction_no);
		
		$("#r_no").val(data.rt_auction_no); //폼 태그 값 지정`
	});
	
	socket.on('user',function(data){//세션을 받는다
		$("#id").val(data);
	});
	
	// 입장인원 체크
	socket.on('userlist',function(data){
		userUpdate(data);
	});
	
	socket.on('text',function(data){
		//입장알림
		var income = "<strong id=income>&nbsp;"+data.nickname+" 님 입장하셨습니다.</strong><br>";
		$("#chat_area").append(income);
		if($('#area').prop('scrollHeight') > $('#area').height()){
			 $('#area').scrollTop($('#area').prop('scrollHeight'));
		}
		//유저 리스트 업데이트
		userUpdate(data.userList);
	});
	
	//퇴장시 알림
	socket.on('exit',function(data){
		var out = "<strong id=out>&nbsp;"+data.msg+"</strong><br>";
		$("#chat_area").append(out);
		if($('#area').prop('scrollHeight') > $('#area').height()){
			 $('#area').scrollTop($('#area').prop('scrollHeight'));
		}
	});
	
	/* 엔터키 입력 & 입력버튼 클릭 */
	$("#chat_text").keypress(function(e){
		if(e.which == 13){
			socket.emit('send',{
				name : $("#id").val(),
				messeage : $("#chat_text").val()
			});
			$("#chat_text").val("");
		}	
	});
	
	$("#chat_enter").click(function(e){
		socket.emit('send',{
			name : $("#id").val(),
			messeage : $("#chat_text").val()
		});
		$("#chat_text").val("");
		e.preventDefault();
	});
	/* */
	
	// 주고받는 메세지
	socket.on('send',function(data){
		var messeage = '&nbsp;[ '+data.nickname+' ] '+data.msg+'<br>';	
		$("#chat_area").append(messeage);
		if($('#area').prop('scrollHeight') > $('#area').height()){
			 $('#area').scrollTop($('#area').prop('scrollHeight'));
		}
	});
	
	// 접속자수 업데이트 함수
	function userUpdate(userList){
		$("#chat_list").empty();
		for(var i=0; i<userList.length; i++){
			var list = userList[i];
			$("#chat_list").append("&nbsp;"+list+'\n');
		}
	}
	
	
	
////////////////////////////////////////////////	
/* 경매 시간 구하기 */
		var now = new Date(); //현재시간 
		var now = finish_auction(now); //현재시간 포맷 변경 
		
		$("#btn_menu button").attr('disabled',true); //초기 로딩시 버튼을 잠가 놓는다.
		$("#btn_menu input").attr('readonly',true);
		
		// _ing 경매중 , end 경매 종료 person 입찰자 
		$(".rt_ing").hide(); 
		$(".rt_end").hide();
		$("#rt_auction_person").hide();
		
		$("#rt_finish_time").text("지금은 경매를 진행하기 위한 대기시간입니다.");
	 	$("#finish_time").text("자유롭게 채팅하세요.");
	 	
		socket.on('wait',function(data){ //경매 대기 상태
			$("#w_minute").text(data.w_m);
			$("#w_second").text(data.w_s);
			$(".rt_ing").hide();
			$(".rt_end").hide();
			
			if(data.w_m == 0 && data.w_s == 0){ // 대기 종료 상태 
				$("#rt_finish_time").text("자유롭게 입찰하세요.");
			 	$("#finish_time").text("입찰 버튼이 활성화 되었습니다.");
			 	
			 	$("#rt_tender").focus();
			 	$("#auction_btn").data('ch', 1).addClass('on');
				$('.auction_menu').animate({
					bottom : '0'
				}, 200);
				
				$(".rt_wait").hide();
				$(".rt_ing").show();
				$("#rt_auction_person").show();
				$(".rt_end").hide();
				$("#end_name").hide();
			}
		});
		
		socket.on('time',function(data){ //경매 진행중 상태 
			$("#minute").text(data.m);
			$("#second").text(data.s);
			$("#btn_menu button").attr('disabled',false); //경매 진행시 버튼을 활성화 시킨다.
			$("#btn_menu input").attr('readonly',false);
			
			if(data.m == 0 && data.s == 0){ //경매 종료 
				$("#rt_finish_time").text("경매 종료 시간");
			
				$("#auction_btn").data('ch', 0).removeClass('on');
				$('.auction_menu').animate({
					bottom : '-80px'
				}, 200);
				$("#chat_text").focus();
				
			 	$("#finish_time").text(now);
				$("#btn_menu button").attr('disabled',true); // 경매 종료시 버튼을 잠근다.
				$("#btn_menu input").attr('readonly',true);
			 	$("#r_date").val(now);
				$(".rt_wait").hide();
				$(".rt_ing").hide();
				$(".rt_end").show();
				$("#end_name").show();
			}
		});
		
		socket.on('out',function(data){
			alert(data);
		});
		
		socket.on('end',function(data){
			alert(data);
			socket.emit('finish',{
				no : $("#r_no").val(),
				id : $("#r_id").val(),
				price : $("#r_price").val(),
				date : $("#r_date").val()
			});
		});
		
		socket.on('finish',function(data){
			
			var check = confirm("해당 경매에 낙찰 되셨습니다.\n" + 
					"경매 번호 : " + data.no + "\n"+
					"낙찰자 : " + data.id + "\n"+
					"낙찰 금액 : " + data.price + "\n"+
					"낙찰 시간 : " + data.date + "\n" +
					"확인을 누르시면 메인으로 이동합니다."
					);
			if(check){
				$.ajax({
					type : 'POST',
					url : 'http://localhost:8081/rt_auction/result_rt_auction',
					data : {
						no : data.no,
						id : data.id,
						price : data.price,
						date : data.date
					},
					dataType : 'html',
					success: function(data){
						
					}
				});
				$(location).attr("href", "http://localhost:8081/");
			}
		});
		
		
	 	//////////////// 경매 종료
		// 날짜 포멧 만들어주는 함수  YYYY-MM-DD HH:MM:SS
		function finish_auction(now){
			var now = leadingZeros(now.getFullYear(),4) + '-' +
					  leadingZeros(now.getMonth()+1,2) + '-' +
					  leadingZeros(now.getDate(),2) + ' ' +
					  leadingZeros(now.getHours(),2) + ':' +
					  leadingZeros(now.getMinutes(),2) + ':' +
					  leadingZeros(now.getSeconds(),2);
			return now;
		}
		
		//형식 고정
		function leadingZeros(n, digits) {
			var zero = "";
			n = n.toString();
			if(n.length < digits){
				for(var i=0; i < digits - n.length; i++){
					zero += 0;
				}
			}
			return zero + n;
		}
	
///////////////////////////////////////////////////////
/* 경매 입찰 (이벤트 & 소켓)*/
	
	// 1천원 클릭
	$("#1000").on('click',function(e){
		
		socket.emit('1000',{ // 소켓 전송
			price : parseInt($(this).val()),
			id : $("#id").val()
		});
		e.preventDefault();
	});
	
	//1000 상대방이 한거 받는 소켓
	socket.on('1000',function(data){
		var sum_1000 = $("#tender_price").text().replace(/[^0-9]/g,"");
		if(sum_1000 == 0){
			$("#r_price").val(data.btn_1+0);
			
			$($("#tender_price").text(data.btn_1+0));
			sum_1000 = $("#tender_price").text();
			sum_1000 = sum_1000.replace(/[^0-9]/g,"");
			sum_1000= parseInt(sum_1000);
		}else{
			sum_1000 = $("#tender_price").text();
			sum_1000 = sum_1000.replace(/[^0-9]/g,"");
			sum_1000= parseInt(sum_1000);
			$($("#tender_price").text(data.btn_1+sum_1000));
			$("#r_price").val(data.btn_1+sum_1000);
		}
		
		$("#r_id").val(data.id);
		$($("#tender_name").text(data.id));
		
		var price = $("#tender_price").text();
		var price_c = numberFormat(price);
		$("#tender_price").text(price_c);
	});
	
	// 5천원 클릭 소켓 전송
	$("#5000").on('click',function(e){
		socket.emit('5000',{
			price : parseInt($(this).val()),
			id : $("#id").val()
		});
		e.preventDefault();
	});
	
	//5000 상대방이 한거 받는 소켓
	socket.on('5000',function(data){
		var sum_5000 = $("#tender_price").text().replace(/[^0-9]/g,"");
		if(sum_5000 == 0){
			$("#r_price").val(data.btn_2+0);
			$($("#tender_price").text(data.btn_2+0));
			sum_5000 = $("#tender_price").text();
			sum_5000 = sum_5000.replace(/[^0-9]/g,"");
			sum_5000= parseInt(sum_5000);
		}else{
			sum_5000 = $("#tender_price").text();
			sum_5000 = sum_5000.replace(/[^0-9]/g,"");
			sum_5000= parseInt(sum_5000);
			$($("#tender_price").text(data.btn_2+sum_5000));
			$("#r_price").val(data.btn_2+sum_5000);
		}
		
		$("#r_id").val(data.id);
		$($("#tender_name").text(data.id));
		
		var price = $("#tender_price").text();
		var price_c = numberFormat(price);
		$("#tender_price").text(price_c);
	});
	
	
	// 1만원 클릭 소켓 전송
	$("#10000").on('click',function(e){
		socket.emit('10000',{
			price : parseInt($(this).val()),
			id : $("#id").val()
		});
		e.preventDefault();
	});
	
	// 10000원 상대방이 한거 받는 소켓
	socket.on('10000',function(data){
		var sum_10000 = $("#tender_price").text().replace(/[^0-9]/g,"");
		if(sum_10000 == 0){
			$("#r_price").val(data.btn_3+0);
			$($("#tender_price").text(data.btn_3+0));
			sum_10000 = $("#tender_price").text();
			sum_10000 = sum_10000.replace(/[^0-9]/g,"");
			sum_10000= parseInt(sum_10000);
		}else{
			sum_10000 = $("#tender_price").text();
			sum_10000 = sum_10000.replace(/[^0-9]/g,"");
			sum_10000= parseInt(sum_10000);
			$("#r_price").val(data.btn_3+sum_10000);
			$($("#tender_price").text(data.btn_3+sum_10000));
		}
		
		$("#r_id").val(data.id);
		$($("#tender_name").text(data.id));
		
		var price = $("#tender_price").text();
		var price_c = numberFormat(price);
		$("#tender_price").text(price_c);
	})
	
	
	/*    직접 금액 입력해서. 입찰 소켓 전송     */
	// 입찰 버튼 클릭
	$("#tender_btn").on('click',function(){
		if(isNaN($("#rt_tender").val()) == false){
			if($("#rt_tender").val()==""){
				alert("공백 입력 불가");
				$("#rt_tender").val("");
				$("#rt_tender").focus();
			}else{
				socket.emit('rt_tender',{
					price : $("#rt_tender").val(),
					id : $("#id").val()
				});
			}
		}else{
			alert("숫자만 입력 가능합니다.");
			$("#rt_tender").val("");
			$("#rt_tender").focus();
		}
		e.preventDefault();
	});
	
	// 엔터키 입력
	$("#rt_tender").keypress(function(e){
		if(e.which == 13){
			if(isNaN($("#rt_tender").val()) == false){
				if($("#rt_tender").val()==""){
					alert("공백 입력 불가");
					$("#rt_tender").val("");
					$("#rt_tender").focus();
				}else{
					socket.emit('rt_tender',{
						price : $("#rt_tender").val(),
						id : $("#id").val()
					});
				}
			}else{
				alert("숫자만 입력 가능합니다.");
				$("#rt_tender").val("");
				$("#rt_tender").focus();
			}
		}	
	});
	
	// 직접 금액 입력한걸 받는 소켓
	socket.on('rt_tender',function(data){
		var sum_tender = $("#tender_price").text().replace(/[^0-9]/g,"");
		if(sum_tender == 0){
			$("#r_price").val(parseInt(data.btn_4)+0);
			$("#tender_price").text(parseInt(data.btn_4)+0);
			sum_tender = $("#tender_price").text();
			sum_tender = sum_tender.replace(/[^0-9]/g,"");
			sum_tender= parseInt(sum_tender);
			$("#rt_tender").val("");
		}else{
			sum_tender = $("#tender_price").text(); //현재입찰가격
			sum_tender = sum_tender.replace(/[^0-9]/g,""); //현재값을 문자열로 정규화
			sum_tender= parseInt(sum_tender); //정수형으로 치환
			$("#tender_price").text(parseInt(data.btn_4)+sum_tender);
			$("#r_price").val(parseInt(data.btn_4)+sum_tender);
			$("#rt_tender").val("");
		}
		
		$("#r_id").val(data.id);
		$($("#tender_name").text(data.id));
		
		var price = $("#tender_price").text();
		var price_c = numberFormat(price);
		$("#tender_price").text(price_c);
	});

	
	// 정규화 함수 3 자리수 마다 , 표시
	function numberFormat(x) {
		return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}
	
///////////////////////////////////////////////////////
/* 이미지 슬라이드 */	
	var time = 500;
    var idx = idx2 = 0;
    var slide_width = $("#slider").width(); //리스트 전체 길이를 구한다 450
    var slide_count = $("#slider li").size(); // 갯수를 구한다 3
    $("#slider li:first").css("display", "block"); //블럭박스로 만든다
    if(slide_count > 1)
        $(".btn").css("display", "inline");
 
    $("#prev_btn").click(function() {
        if(slide_count > 1) {
            idx2 = (idx - 1) % slide_count;
            if(idx2 < 0)
                idx2 = slide_count - 1;
            $("#slider li:hidden").css("left", "-"+slide_width+"px");
            $("#slider li:eq("+idx+")").animate({ left: "+="+slide_width+"px" }, time, function() {
                $(this).css("display", "none").css("left", "-"+slide_width+"px");
            });
            $("#slider li:eq("+idx2+")").css("display", "block").animate({ left: "+="+slide_width+"px" }, time);
            idx = idx2;
        }
    });
 
    $("#next_btn").click(function() {
        if(slide_count > 1) {
            idx2 = (idx + 1) % slide_count;
            $("#slider li:hidden").css("left", slide_width+"px");
            $("#slider li:eq("+idx+")").animate({ left: "-="+slide_width+"px" }, time, function() {
                $(this).css("display", "none").css("left", slide_width+"px");
            });
            $("#slider li:eq("+idx2+")").css("display", "block").animate({ left: "-="+slide_width+"px" }, time);
            idx = idx2;
        }
    });
	
});
</script>
</head>
<body>
<form id="rt_acution_finish" method="POST" style="display: none;">
	<input type="text" id="r_no" value="">
	<input type="text" id="r_id" value="">
	<input type="text" id="r_price" value="">
	<input type="text" id="r_date" value="">
</form>
<section class="auction_body" id="auction_body">
		<div class="auction_info" id="auction_info">
		<div class= "slider_background">
			<div class="no_info">
				<strong id="rt_auction_no_box">경매 번호</strong>
				<strong id="rt_auction_no"></strong>
			</div>
			<ul id="slider">
				<li><img id="rt_img" alt="rt_img" src=""></li>
				<li><img id="rt_img01" alt="rt_img01" src=""></li>
				<li><img id="rt_img02" alt="rt_img02" src=""></li>
			</ul>
			<button type="button" id="prev_btn" class="btn"></button>
			<button type="button" id="next_btn" class="btn"></button>
		</div>
			
			<div class="auction_content" id="auction_centent">
				<strong id="name">상 품 명</strong><strong id="rt_name"></strong>
				<strong id="product_area">생 산 지</strong><strong id="rt_area"></strong><br>
				<strong id="standard">규 격</strong><strong id="rt_standard"></strong>
				<strong id="seller">판 매 자</strong><strong id="rt_seller"></strong><br>
				<strong id="content">상 품 설 명</strong>
				<div class="rt_content" id="rt_content">
				
				</div>
			</div>
		</div>
			<div class="auction_time_price" id="auction_time_price">
				<div id="time">
					<div class="rt_wait">
						<strong id="w_time">경매 대기 시간</strong>
						<strong id="w_minute"></strong><em>분</em>
						<strong id="w_second"></strong><em>초</em>
					</div>
					<div class="rt_ing">
						<strong id="rt_time">경매 진행 중</strong>
						<strong id="minute"></strong><em>분</em>
						<strong id="second"></strong><em>초</em>
					</div>
					<div class="rt_end">
						<strong id="end">경매가 종료 되었습니다.</strong>
					</div>
				</div>
				<div id="rt_auction_finish_time">
					<strong id=rt_finish_time></strong><br>
					<strong id="finish_time"></strong>
				</div>
				<div id="rt_auction_person">
					<strong id="end_name">최종 낙찰자&nbsp;</strong><strong id="tender_name">입찰자</strong><em>님</em>
					<strong id="tender_price">입찰금액</strong><em>원</em>
				</div>
			</div>
				<div class="chat_body" id="chat_body">
					<div id="area" class="area" style="overflow: auto;">
						<div id="chat_area" class="chat_area"></div>
					</div>
						<textarea id="chat_list" name="chat_list" rows="18" cols="11" readonly="readonly"></textarea><br>
				</div>
				<div class="chat_input" id="chat_input">
					<input type="text" id="id" name="id" value="" readonly="readonly">
					<input type="text" id="chat_text" name="chat_text" >
					<button id="chat_enter" name="chat_enter">입력</button>
				</div>
		<div class="auction_menu" id="auction_menu" style="bottom: -80px">
					<button id="auction_btn" name="auction_btn">입&nbsp;&nbsp;&nbsp;&nbsp;찰</button>
				<div id="auction_box" id="auction_box">
					<div id="btn_menu" class="btn_menu">
						<button id="1000" value="1000">1,000</button>
						<button id="5000" value="5000">5,000</button>
						<button id="10000" value="10000">10,000</button>
						<input type="text" id=rt_tender>
						<button id="tender_btn">입찰</button>
					</div>
				</div>
		</div>
	</section>
</body>
</html>

<style>
/* 경매번호 */
.slider_background{
	height: 400px;
}
.no_info{
	padding : 20px 0 10px 15px;
}
#rt_auction_no{
	color : #38a9a5;
}

/* 제품 내용 */
#name{
	font-size: 15px;
	margin-right: 10px;
}
#rt_name{
	font-size: 15px;
	color: #38a9a5;
}
#product_area{
	font-size: 15px;
	margin-right: 10px;
	margin-left: 10px;
}
#rt_area{
	font-size: 15px;
	color: #38a9a5;
}
#standard{
	font-size: 15px;
	margin-right: 25px;
}
#rt_standard{
	font-size: 15px;
	color: #38a9a5;
}
#seller{
	font-size: 15px;
	margin-left: 25px;
	margin-right: 10px;
}
#rt_seller{
	font-size: 20px;
	color: #38a9a5;
}
#content{
	font-size: 15px;
	position: relative;
	top: 5px;
}
#prev_btn{
	background-image: url(/btn_img01);
	background-repeat: no-repeat;
	background-size: 30px;
	margin-left : 40%;
}
#next_btn{
	margin-left : 5%;
	background-image: url(/btn_img02);
	background-repeat: no-repeat;
	background-size: 30px;
}
.btn {
	margin-top : 10px;
	width : 30px;
	height:30px;
	border:0;
	background:#f5f6fa;
	display:none;
}
#slider {
	position:relative;
	margin:0 auto;
	padding:0;
	list-style:none;
	width:450px;
	height:300px;
	overflow-x:hidden
}
#slider li {
	display:none;
	position:absolute;
	left:0;
	top:0;
}
#slider img {
	width:450px;
	height:300px
}
.auction_info {
	margin-left: 10px;
	height: 650px;
	width: 45%;
	float: left;
}
.auction_content {
	padding-top : 10px;
	padding-left : 10px;
	margin-left: 20px;
	height: 240px;
	width: 90%;
}
.rt_content{
	padding-top: 10px;
}

/* 경매 대기 관련 CSS */
.rt_wait{
	text-align: center;
}
#w_time{
	font-size: 25px;
	margin-right: 10px;
}
#w_minute{
	color : #38a9a5;
	font-size: 55px;
}
#w_second{
	color : #38a9a5;
	font-size: 55px;
	margin-left: 10px;
}

/* 경매 입찰 관련 CSS */
.rt_ing{
	text-align: center;
}
#time{
	margin-left: 25px;
	margin-bottom: 10px;
}
#time em{
	margin-left : 5px;
	font-size: 35px;
}
#rt_time{
	font-size: 25px;
	margin-right: 10px;
}
#minute{
	color : #38a9a5;
	font-size: 55px;
}
#second{
	color : #38a9a5;
	font-size: 55px;
	margin-left: 10px;
}
#rt_auction_finish_time{
	text-align: center;
}
#rt_finish_time{
	font-size: 15px;
}

#finish_time{
	font-size: 20px;
	color : #38a9a5;
}
#rt_auction_person{
	margin-top : 10px;
	margin-left : 40px;
	font-size: 35px;
}
#rt_auction_person strong{
	color : #e2704b;
	font-size: 25px;
	margin-right: 20px;
	margin-left: 5px;
}
#rt_auction_person em{
	margin-right: 5px;
}
#tender_price{
	margin-left: 10px;
}

/* 경매 종료 관련 CSS */
#end{
	margin-left : 50px;
	font-size: 35px;
}

/* 입찰 버튼 CSS */
.auction_menu {
	position: fixed;
	width: 79%;
}
#auction_btn {
	border: 0px;
	padding: 0px;
	height : 32px;
	width: 100%;
	background-color: #7fb1bf;
	color: white;
  	font-size: 20px;
  	border-radius: 5px;
}
#auction_box {
	height: 80px;
	background-color: #eaedf1;
	text-align: center;
	font-family: 'Lato', sans-serif;
	border-radius: 5px;
	border-right: 2px solid #7fb1bf;
	border-left: 2px solid #7fb1bf;
	border-top: 2px solid #7fb1bf;
}
#auction_box button{
	color: white;
	position : relative;
	top : 15px;
	margin-right: 60px;
	padding: 10px 40px; 
  	font-size: 20px;
  	background-color: #7fb1bf;
  	border-radius: 5px;
}
#auction_box input{
	position : relative;
	top : 12px;
	margin-right: 25px;
	height: 48px;
	border-radius: 5px;
}
#income{
	color: green;
}
#out{
	color: red;
}
.auction_body {
	padding-top: 20px;
	margin-left: 10%;
	margin-right: 10%;
	width: 80%;
	height: 700px;
}
.auction_time_price {
	position: absolute;
	left: 48%;
	height: 180px;
	width: 38%;
}
#area {
	position: relative;
	top: 200px;
	border: 1px solid blue;
	margin-left: 15px;
	width : 355px;
	height : 402px;
	float : left;
}
#chat_list {
	border: 1px solid green;
	height : 402px;
	margin-left : 25px;
	float : left;
	position: relative;
	top: 200px;
	resize: none;
	font-size: 15px;
	font-weight: bold;
	text-align: center;
}
#chat_input{
	position: relative;
	top: 220px;
	float : left;
	margin-left: 15px;
	width: 48.3%;
}
#id {
	width: 20%;
	text-align: center;
}
#chat_text {
	width: 48%;
}
#chat_enter {
	margin-left : 19px;
	width: 26%;
}

</style>
